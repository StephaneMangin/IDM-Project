package org.irisa.diverse.videogen.videoGen.aspects.visitors

import org.eclipse.core.resources.ResourcesPlugin
import org.irisa.diverse.videogen.transformations.VideoGenTransform
import org.irisa.diverse.videogen.transformations.helpers.VideoGenHelper
import org.irisa.diverse.videogen.videoGen.Transition
import org.irisa.diverse.videogen.videoGen.Video
import org.irisa.diverse.videogen.videoGen.VideoGen
import org.irisa.diverse.videogen.videoGen.aspects.TransitionAspect
import org.irisa.diverse.videogen.videoGen.aspects.utils.LoggableVisitor
import org.irisa.diverse.videogen.videoGen.Alternatives
import fr.inria.diverse.k3.al.annotationprocessor.Aspect

class VideoGenSetupVisitor extends LoggableVisitor {
	
	private var VideoGen videoGen
	
	def void visit(VideoGen vid) {
		videoGen = vid
		log.info("VideoGen Setup Visitor started...")
		VideoGenHelper.allTransitions(vid).forEach[visit]
		VideoGenHelper.allSequences(vid).forEach[visit]
		VideoGenHelper.allVideos(vid).forEach[visit]
	}
	
	def private void visit(Transition tra) {
	}
	
	def private void visit(Video video) {
		log.info(video.toString)
		if (!video.url.startsWith("/")) {
			val prefix = ResourcesPlugin.workspace.root.projects.get(0).locationURI.toString.replace("file:", "")
			val newPath = prefix + "/" + video.url
			log.info(video.url + "=>" + newPath)
			video.setUrl(newPath)
		}
		// Add duration and VideoCodec MimeType
		VideoGenTransform.addMetadata(video)
		log.info("Video configured => " + video.duration + ", " + video.mimetype)
	}
}

@Aspect(className=VideoGen)
class VideoGenVariantsAspect {
	    
	def VideoGen findVariants() {
		_self.variantes = 1
		println("VideoGen Variants Visitor started...")
		// Call the visitor
		_self.transitions.filter[it instanceof Sequence]
			.map[it as Sequence]
			.forEach[findVariants(_self)]
		_self
	}
}

@Aspect(className=Transition)
class TransitionSetupAspect {

	def private void findVariants(VideoGen vid) {
		_self.selected = false
		_self.active = true
		_self.executed = false
		vid.videoGen = videoGen
		if (_self instanceof Alternatives) {
			_self.options.forEach[opt |
				opt.selected = false
				opt.active = true
				opt.executed = false
				_self.videoGen(opt, videoGen)
			]
		}
	}
}

@Aspect(className=Sequence)
class SequenceSetupAspect {

	def private void findVariants(VideoGen vid) {
		if (_self.active) {
			println("VideoGen Variants Visitor : " + _self)
			if (_self instanceof Optional) {
				_self.findVariants(vid)
			} else if (_self instanceof Alternatives) {
				_self.findVariants(vid)
			}
			println("VideoGen Variants Visitor : " + vid.variantes)
		}
	}
}

@Aspect(className=Alternatives)
class AlternativesSetupAspect {
	
	def private void findVariants(VideoGen vid) {
		vid.variantes = vid.variantes * _self.options.filter[active].size
	}
}

@Aspect(className=Optional)
class OptionalSetupAspect {
	
	def private void findVariants(VideoGen vid) {
		vid.variantes = vid.variantes * 2
	}
}